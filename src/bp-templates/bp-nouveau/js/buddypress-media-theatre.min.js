window.bp=window.bp||{},function(e,i){"undefined"!=typeof BP_Nouveau&&(bp.Nouveau=bp.Nouveau||{},bp.Nouveau.Media.Theatre={start:function(){this.setupGlobals(),this.addListeners()},setupGlobals:function(){this.medias=[],this.current_media=!1,this.current_index=0,this.is_open=!1,this.nextLink=i(".bb-next-media"),this.previousLink=i(".bb-prev-media"),this.activity_ajax=!1},addListeners:function(){i(document).on("click",".bb-open-media-theatre",this.openTheatre.bind(this)),i(document).on("click",".bb-close-media-theatre",this.closeTheatre.bind(this)),i(document).on("click",".bb-prev-media",this.previous.bind(this)),i(document).on("click",".bb-next-media",this.next.bind(this)),i(document).on("bp_activity_ajax_delete_request",this.activityDeleted.bind(this))},documentClick:function(e){var i=this;if(i.is_open){var t=e.target,n=document.getElementById("bb-media-model-container");null!=n&&!n.contains(t)&&document.body.contains(t)&&i.closeTheatre(e)}},checkPressedKey:function(e){var i=this;switch((e=e||window.event).keyCode){case 27:i.closeTheatre(e);break;case 37:i.previous(e);break;case 39:i.next(e)}},openTheatre:function(e){e.preventDefault();var t,n=i(e.currentTarget),a=this;if(n.closest("#bp-existing-media-content").length)return!1;a.setupGlobals(),a.setMedias(n),t=n.data("id"),a.setCurrentMedia(t),a.showMedia(),a.navigationCommands(),a.getActivity(),i(".bb-media-model-wrapper").show(),a.is_open=!0,document.addEventListener("keyup",a.checkPressedKey.bind(a))},closeTheatre:function(e){e.preventDefault();var t=this;i(".bb-media-model-wrapper").hide(),t.is_open=!1,document.removeEventListener("keyup",t.checkPressedKey.bind(t))},setMedias:function(e){var t=i(".bb-open-media-theatre"),n=0,a=this;if(i("body").hasClass("activity")&&(t=i(e).closest(".bb-activity-media-wrap").find(".bb-open-media-theatre")),void 0!==t)for(a.medias=[],n=0;n<t.length;n++){var d=i(t[n]);if(!d.closest("#bp-existing-media-content").length){var r={id:d.data("id"),attachment:d.data("attachment-full"),activity_id:d.data("activity-id"),is_forum:!1};d.closest(".forums-media-wrap").length&&(r.is_forum=!0),a.medias.push(r)}}},setCurrentMedia:function(e){var i=this,t=0;for(t=0;t<i.medias.length;t++)if(e===i.medias[t].id){i.current_media=i.medias[t],i.current_index=t;break}},showMedia:function(){var e=this;i(".bb-media-model-wrapper .bb-media-section").find("img").attr("src",e.current_media.attachment+"?"+(new Date).getTime()),e.navigationCommands()},next:function(e){e.preventDefault();var i,t=this;void 0!==t.medias[t.current_index+1]?(t.current_index=t.current_index+1,i=t.current_media.activity_id,t.current_media=t.medias[t.current_index],t.showMedia(),i!=t.current_media.activity_id&&t.getActivity()):t.nextLink.hide()},previous:function(e){e.preventDefault();var i,t=this;void 0!==t.medias[t.current_index-1]?(t.current_index=t.current_index-1,i=t.current_media.activity_id,t.current_media=t.medias[t.current_index],t.showMedia(),i!=t.current_media.activity_id&&t.getActivity()):t.previousLink.hide()},navigationCommands:function(){var e=this;0==e.current_index&&e.current_index!=e.medias.length-1?(e.previousLink.hide(),e.nextLink.show()):0==e.current_index&&e.current_index==e.medias.length-1?(e.previousLink.hide(),e.nextLink.hide()):e.current_index==e.medias.length-1?(e.previousLink.show(),e.nextLink.hide()):(e.previousLink.show(),e.nextLink.show())},getActivity:function(){var e=this;i(".bb-media-info-section .activity-list").addClass("loading").html('<i class="dashicons dashicons-update animate-spin"></i>'),void 0!==BP_Nouveau.activity&&e.current_media&&void 0!==e.current_media.activity_id&&0!=e.current_media.activity_id&&!e.current_media.is_forum?(0!=e.activity_ajax&&e.activity_ajax.abort(),e.activity_ajax=i.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:{action:"media_get_activity",id:e.current_media.activity_id,nonce:BP_Nouveau.nonces.media},success:function(e){e.success&&(i(".bb-media-info-section .activity-list").removeClass("loading").html(e.data.activity),i(".bb-media-info-section").show())}})):i(".bb-media-info-section").hide()},activityDeleted:function(e,t){var n=this,a=0;if(n.is_open&&void 0!==t&&"delete_activity"===t.action&&n.current_media.activity_id==t.id){for(i(document).find('[data-bp-list="media"] .bb-open-media-theatre[data-id="'+n.current_media.id+'"]').closest("li").remove(),i(document).find('[data-bp-list="activity"] .bb-open-media-theatre[data-id="'+n.current_media.id+'"]').closest(".bb-activity-media-elem").remove(),a=0;a<n.medias.length;a++)if(n.medias[a].activity_id==t.id){n.medias.splice(a,1);break}0==n.current_index&&n.current_index!=n.medias.length?(n.current_index=-1,n.next(e)):0==n.current_index&&n.current_index==n.medias.length?n.closeTheatre(e):n.current_index==n.medias.length?n.previous(e):(n.current_index=-1,n.next(e))}}},bp.Nouveau.Media.Theatre.start())}(bp,jQuery);
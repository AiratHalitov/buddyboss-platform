window.wp=window.wp||{},window.bp=window.bp||{},function(e,s){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Models.ACReply=Backbone.Model.extend({defaults:{gif_data:{}}}),bp.Nouveau.GroupMessages={start:function(){this.views=new Backbone.Collection,this.displayFeedback(BP_Nouveau.group_messages.invites_form_all,"info"),this.mediumEditor=!1,this.setupGlobals();var e=s("body").find("#group-messages-send-to-input"),a=1;this.addSelect2(e),this.activateTinyMce();var o=s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback"),t=s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback p"),r=s("#group-messages-container .bb-groups-messages-left .group-messages-members-listing .bp-messages-feedback"),g=s("#group-messages-container .bb-groups-messages-left .group-messages-members-listing .bp-messages-feedback .bp-feedback p");e.on("select2:unselect",function(e){var a=e.params.data;s('#group-messages-send-to-input option[value="'+a.id+'"]').each(function(){s(this).remove()}),s("#item-body #group-messages-container .bb-groups-messages-left #members-list li."+a.id).removeClass("selected")}),s(".group-messages-select-members-dropdown").on("change",function(){e.val("").trigger("change");var m=this.value;if(m){if(o.addClass("bp-messages-feedback-hide"),r.addClass("bp-messages-feedback-hide"),t.html(""),"all"===m)return o.removeClass("bp-messages-feedback-hide"),s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback").addClass("info"),t.html(BP_Nouveau.group_messages.invites_form_all),s("#group-messages-container .bb-groups-messages-left .group-messages-search").hide(),s("#group-messages-container .bb-groups-messages-left .group-messages-members-listing").hide(),e.select2("data",{id:BP_Nouveau.group_messages.select_default_value,text:BP_Nouveau.group_messages.select_default_text}),e.val("all").trigger("change"),1;o.removeClass("bp-messages-feedback-hide"),r.removeClass("bp-messages-feedback-hide"),s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback").addClass("info"),t.html(BP_Nouveau.group_messages.invites_form_separate),s("#group-messages-container .bb-groups-messages-left .group-messages-search").show(),s("#group-messages-container .bb-groups-messages-left .group-messages-members-listing").show(),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("loading"),g.html(BP_Nouveau.group_messages.loading);var u={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,page:a};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,async:!1,data:u,success:function(e){if(e.success&&"no_member"!==e.data.results)return s(".group-messages-members-listing #members-list").html(""),s(".group-messages-members-listing #members-list").html(e.data.results),s(".group-messages-members-listing .last").html(""),s(".group-messages-members-listing .last").html(e.data.pagination),a=e.data.page,s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide(),a;s(".group-messages-members-listing #members-list").html(""),s(".group-messages-members-listing .last").html(""),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),g.html(BP_Nouveau.group_messages.no_member)}})}}),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-left #members-list li .action .group-add-remove-invite-button",function(){var a=s(this).attr("data-bp-user-id"),o=s(this).attr("data-bp-user-name"),t={id:a,text:o};if(s(this).closest("li").hasClass("selected")){s(this).closest("li").removeClass("selected");var r=[];s.grep(e.select2("data"),function(e){return e.id!=a}).forEach(function(e){r.push(+e.id)}),e.val(r).trigger("change"),s('#group-messages-send-to-input option[value="'+a+'"]').each(function(){s(this).remove()})}else if(s(this).closest("li").addClass("selected"),!e.find("option[value='"+t.id+"']").length){var g=new Option(t.text,t.id,!0,!0);e.append(g).trigger("change")}}),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-left .last #bp-group-messages-next-page",function(){s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").show();var e={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,page:a};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:e,success:function(e){e.success&&"no_member"!==e.data.results?(s(".group-messages-members-listing #members-list").html(""),s(".group-messages-members-listing #members-list").html(e.data.results),s(".group-messages-members-listing .last").html(""),s(".group-messages-members-listing .last").html(e.data.pagination),a=e.data.page,s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide()):(s(".group-messages-members-listing #members-list").html(""),s(".group-messages-members-listing .last").html(""),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),g.html(BP_Nouveau.group_messages.no_member))}})}),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-left .last #bp-group-messages-prev-page",function(){s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").show(),a-=2;var e={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,page:a};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:e,success:function(e){e.success&&"no_member"!==e.data.results?(s(".group-messages-members-listing #members-list").html(""),s(".group-messages-members-listing #members-list").html(e.data.results),s(".group-messages-members-listing .last").html(""),s(".group-messages-members-listing .last").html(e.data.pagination),s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide(),a=e.data.page):(s(".group-messages-members-listing #members-list").html(""),s(".group-messages-members-listing .last").html(""),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),g.html(BP_Nouveau.group_messages.no_member))}})}),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-left #group_messages_search",function(){var e={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,page:1};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:e,success:function(e){e.success&&"no_member"!==e.data.results?(s(".group-messages-members-listing #members-list").html(""),s(".group-messages-members-listing #members-list").html(e.data.results),s(".group-messages-members-listing .last").html(""),s(".group-messages-members-listing .last").html(e.data.pagination),s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide(),a=e.data.page):(s(".group-messages-members-listing #members-list").html(""),s(".group-messages-members-listing .last").html(""),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),g.html(BP_Nouveau.group_messages.no_member))}})}),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-left #group_messages_search_submit",function(e){e.preventDefault(),s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").show(),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").removeClass("error"),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("info"),g.html(BP_Nouveau.group_messages.loading);var a=s("#item-body #group-messages-container .bb-groups-messages-left .group-messages-search .bp-search #group_messages_search_form #group_messages_search").val(),o={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,term:a};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:o,success:function(e){e.success&&"no_member"!==e.data.results?(s(".group-messages-members-listing #members-list").html(""),s(".group-messages-members-listing #members-list").html(e.data.results),s(".group-messages-members-listing .last").html(""),s(".group-messages-members-listing .last").html(e.data.pagination),s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide()):(s(".group-messages-members-listing #members-list").html(""),s(".group-messages-members-listing .last").html(""),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),g.html(BP_Nouveau.group_messages.no_member))}})})},setupGlobals:function(){void 0!==window.Dropzone&&void 0!==BP_Nouveau.media&&(window.Dropzone.autoDiscover=!1,this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFilesize:void 0!==BP_Nouveau.media.max_upload_size?BP_Nouveau.media.max_upload_size:2}),this.dropzone_obj=null,this.dropzone_media=[],this.models=[]},activateTinyMce:function(){if(_.isUndefined(window.MediumEditor))"undefined"!=typeof tinymce&&tinymce.EditorManager.execCommand("mceAddEditor",!0,"message_content");else{new window.MediumEditor("#group_message_content",{placeholder:{text:"",hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor"]}}),_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.emoji)||s("#group_message_content").emojioneArea({standalone:!0,hideSource:!1,container:s("#whats-new-toolbar > .post-emoji"),autocomplete:!1,pickerPosition:"bottom",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){s("#group_message_content")[0].emojioneArea.hidePicker()}}});var e=bp.Nouveau.getLinkParams(null,"r")||null;_.isNull(e)||s("#message_content").focus()}},addMentions:function(){s(this.el).find("#group-messages-send-to-input").bp_mentions({data:[],suffix:" "})},addSelect2:function(e){var a=[];e.select2({placeholder:e.attr("placeholder"),minimumInputLength:1,ajax:{url:bp.ajax.settings.url,dataType:"json",delay:250,data:function(e){return s.extend({},e,{nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,action:"groups_get_group_potential_user_send_messages",group:BP_Nouveau.group_messages.group_id})},cache:!0,processResults:function(e){return!1===jQuery.isEmptyObject(a)&&s.each(a,function(s,a){for(var o=0;o<e.data.results.length;o++)e.data.results[o].id===a&&e.data.results.splice(o,1)}),{results:e&&e.success?e.data.results:[]}}}}),e.on("select2:select",function(e){var s=e.params.data;a.push(s.id)}),e.on("select2:unselect",function(e){var s=e.params.data;a=jQuery.grep(a,function(e){return e!==s.id})})},displayFeedback:function(e,a){s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback").removeClass("bp-messages-feedback-hide"),s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback").addClass(a),s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html(e)},removeFeedback:function(){s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback").addClass("bp-messages-feedback-hide"),s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html("")}},bp.Nouveau.GroupMessages.start())}(bp,jQuery);